# Story 4.2: order-status-management

## Status
Draft

## Story
**As a** 客户和商户运营者,
**I want** 实时了解订单的处理状态,
**so that** 跟踪订单进展并及时处理问题

## Acceptance Criteria

1. **订单状态定义（已下单、已支付、处理中、已完成、已取消）**: 完善订单状态枚举和状态流转规则
2. **订单状态变更API和自动状态流转机制**: 后端API支持订单状态变更和业务逻辑触发的自动状态流转
3. **订单详情查询API，包含完整的订单信息和状态历史**: 提供订单详情查询接口，包含状态变更历史记录
4. **客户端订单列表和详情页面**: 前端订单管理页面，支持状态筛选和详情查看
5. **商户端订单管理界面，支持批量操作**: 商户运营界面的订单管理功能，支持批量状态变更
6. **订单状态变更通知机制（客户和商户双向通知）**: 状态变更时的实时通知系统
7. **订单超时处理和自动取消机制**: 超时订单的自动状态变更和处理机制

## Tasks / Subtasks

**执行顺序**: Task 1 → Task 2 → Task 3 → (Task 4 || Task 5) → Task 6 → Task 7

- [ ] **Task 1: 完善订单状态管理架构** (AC: 1, 2)
  - **前置条件**: Story 4.1完成，Order Service基础架构可用
  - **预估时间**: 2天
  - [ ] 扩展Order数据模型，添加状态历史记录功能
  - [ ] 实现OrderStatusHistory实体和Repository层
  - [ ] 创建订单状态流转业务规则和验证逻辑
  - [ ] 实现订单状态变更API和事务安全机制
  - **完成标准**: 订单状态管理架构完整，支持状态历史追踪

- [ ] **Task 2: 实现订单查询和列表功能** (AC: 3, 4)
  - **依赖**: Task 1完成，订单状态管理可用
  - **预估时间**: 1.5天
  - [ ] 扩展订单查询API，支持状态筛选和分页
  - [ ] 实现订单详情查询API，包含状态历史
  - [ ] 创建订单搜索和过滤功能
  - [ ] 优化订单列表查询性能（索引优化）
  - **完成标准**: 订单查询功能完整，支持多维度筛选

- [ ] **Task 3: 开发客户端订单管理界面** (AC: 4) [可与Task 4并行]
  - **依赖**: Task 2完成，订单查询API可用
  - **预估时间**: 2天
  - [ ] 创建客户订单列表页面，使用Amis构建
  - [ ] 实现订单详情页面，展示状态历史和流转信息
  - [ ] 添加订单状态筛选和搜索功能
  - [ ] 集成订单状态实时更新机制
  - **完成标准**: 客户端订单管理界面完整，用户体验良好

- [ ] **Task 4: 开发商户端订单管理界面** (AC: 5) [可与Task 3并行]
  - **依赖**: Task 2完成，订单查询API可用
  - **预估时间**: 2.5天
  - [ ] 创建商户订单管理页面，支持订单状态变更操作
  - [ ] 实现批量订单操作功能（批量处理、批量取消）
  - [ ] 添加订单统计和报表展示组件
  - [ ] 集成订单操作权限控制和多租户隔离
  - **完成标准**: 商户端订单管理功能完整，支持批量操作

- [ ] **Task 5: 实现订单状态通知系统** (AC: 6)
  - **依赖**: Task 1完成，状态变更API可用
  - **预估时间**: 2天
  - [ ] 扩展通知服务，支持订单状态变更通知
  - [ ] 实现客户端实时通知机制（WebSocket或Server-Sent Events）
  - [ ] 创建商户端订单状态变更通知
  - [ ] 集成短信和邮件通知模板和发送逻辑
  - **完成标准**: 订单状态通知系统完整，支持多渠道通知

- [ ] **Task 6: 实现订单超时和自动处理机制** (AC: 7)
  - **依赖**: Task 1完成，状态管理系统可用
  - **预估时间**: 2天
  - [ ] 设计订单超时规则和配置机制
  - [ ] 实现定时任务处理超时订单（Go定时器或Cron Job）
  - [ ] 创建订单自动取消和库存释放逻辑
  - [ ] 集成权益返还和支付退款处理
  - **完成标准**: 订单超时处理机制完整，支持自动化处理

- [ ] **Task 7: 单元测试和集成测试** (所有AC)
  - **依赖**: Task 1-6全部完成
  - **预估时间**: 2天
  - [ ] 编写订单状态管理的单元测试
  - [ ] 创建订单查询和列表API的集成测试
  - [ ] 实现订单状态通知的端到端测试
  - [ ] 验证订单超时处理的定时任务测试
  - **完成标准**: 测试覆盖率≥85%，所有测试通过

## Dev Notes

### Previous Story Insights
从Story 4.1在线下单与支付流程的完成记录中获得的关键信息：
- **订单管理基础架构成熟**：Order Service已建立，支持订单创建、购物车管理和支付集成 [Source: Story 4.1 completion notes]
- **多租户数据隔离验证**：Repository层自动注入tenant_id，确保订单数据安全隔离 [Source: Story 4.1 completion notes]
- **通知系统基础**：已实现短信和邮件通知服务，支持订单创建和支付状态通知 [Source: Story 4.1 completion notes]
- **前端组件架构**：React+Amis+Zustand技术栈验证成功，支持订单相关界面开发 [Source: Story 4.1 completion notes]
- **API架构成熟**：RESTful API设计完善，支持JWT认证和权限控制 [Source: Story 4.1 completion notes]

### Data Models
**基于架构文档的订单状态管理数据模型** [Source: docs/architecture/data-models.md]:

**扩展Order实体** [Source: data-models.md#Order]:
```typescript
interface Order {
  id: string;
  tenant_id: string;
  merchant_id: string;
  customer_id: string;
  order_number: string;
  status: OrderStatus;
  items: OrderItem[];
  payment_info: PaymentInfo;
  verification?: VerificationInfo;
  total_amount: Money;
  total_rights_cost: number;
  status_history: OrderStatusHistory[];  // 新增：状态历史记录
  timeout_config: OrderTimeoutConfig;    // 新增：超时配置
  created_at: Date;
  updated_at: Date;
}

enum OrderStatus {
  PENDING = 'pending',           // 待支付
  PAID = 'paid',                // 已支付
  PROCESSING = 'processing',     // 处理中
  COMPLETED = 'completed',       // 已完成
  CANCELLED = 'cancelled'        // 已取消
}

interface OrderStatusHistory {
  id: string;
  order_id: string;
  from_status: OrderStatus;
  to_status: OrderStatus;
  reason: string;                // 状态变更原因
  operator_id?: string;          // 操作员ID（系统自动为空）
  operator_type: 'customer' | 'merchant' | 'system' | 'admin';
  created_at: Date;
  metadata?: any;                // 额外的状态变更信息
}

interface OrderTimeoutConfig {
  payment_timeout_minutes: number;     // 支付超时时间（分钟）
  processing_timeout_hours: number;    // 处理超时时间（小时）
  auto_complete_enabled: boolean;      // 是否启用自动完成
}
```

**订单查询和筛选模型**:
```typescript
interface OrderQueryRequest {
  tenant_id: string;
  merchant_id?: string;
  customer_id?: string;
  status?: OrderStatus[];
  start_date?: Date;
  end_date?: Date;
  search_keyword?: string;       // 订单号或商品名称搜索
  page: number;
  page_size: number;
  sort_by: 'created_at' | 'updated_at' | 'total_amount';
  sort_order: 'asc' | 'desc';
}

interface OrderListResponse {
  items: OrderSummary[];
  total: number;
  page: number;
  page_size: number;
  has_next: boolean;
}

interface OrderSummary {
  id: string;
  order_number: string;
  status: OrderStatus;
  customer_name: string;
  merchant_name: string;
  total_amount: Money;
  item_count: number;
  created_at: Date;
  updated_at: Date;
  latest_status_change: OrderStatusHistory;
}
```

### API Specifications
**订单状态管理API端点设计** [基于architecture/backend-architecture.md]:

**订单状态管理API端点**:
- PUT /api/v1/orders/{order_id}/status - 更新订单状态
- GET /api/v1/orders/{order_id}/status-history - 获取订单状态历史
- POST /api/v1/orders/batch-update-status - 批量更新订单状态
- GET /api/v1/orders/stats - 获取订单状态统计信息

**订单查询API端点**:
- GET /api/v1/orders - 获取订单列表（支持多维度筛选）
- GET /api/v1/orders/{order_id} - 获取订单详情（包含状态历史）
- GET /api/v1/orders/search - 订单搜索（支持关键词搜索）
- GET /api/v1/merchants/{merchant_id}/orders - 商户订单管理

**订单通知API端点**:
- POST /api/v1/orders/{order_id}/notify - 手动触发订单通知
- GET /api/v1/orders/{order_id}/notifications - 获取订单通知历史
- WebSocket: /ws/orders/status-updates - 订单状态实时更新

**认证和授权要求** [Source: architecture/backend-architecture.md#Auth]:
- 订单状态查询需要权限：'order:read'
- 订单状态变更需要权限：'order:update'
- 商户订单管理需要权限：'order:manage'
- 批量操作需要权限：'order:batch'
- 订单通知管理需要权限：'order:notify'

### Component Specifications
**Order Service扩展架构** [基于architecture/components.md#OrderService]:
- **新增职责**: 订单状态管理、状态历史追踪、超时处理、批量操作 [Source: components.md#OrderService]
- **技术栈**: Go + GoFrame + 定时任务处理 [Source: architecture/tech-stack.md]
- **依赖服务**: 通知服务、权限服务、Fund Service（权益退还） [Source: components.md#OrderService]
- **新增组件**: OrderStatusManager, OrderTimeoutHandler, OrderBatchProcessor

**前端订单状态管理架构** [Source: architecture/frontend-architecture.md]:
- 使用React 18.2+ + TypeScript 5.3+ [Source: architecture/tech-stack.md]
- 采用Amis 6.0+构建订单状态管理界面 [Source: architecture/tech-stack.md]
- 状态管理使用Zustand 4.4+ [Source: architecture/tech-stack.md]
- WebSocket集成用于实时状态更新
- 扩展现有订单管理模块

### File Locations
**后端文件位置** [Source: architecture/unified-project-structure.md]:
- backend/services/order-service/internal/controller/order_status.go - 订单状态API控制器（需创建）
- backend/services/order-service/internal/service/order_status.go - 订单状态业务逻辑（需创建）
- backend/services/order-service/internal/service/order_timeout.go - 订单超时处理服务（需创建）
- backend/services/order-service/internal/service/order_batch.go - 批量操作服务（需创建）
- backend/shared/repository/order_status_history.go - 状态历史数据访问层（需创建）
- backend/shared/types/order_status.go - 订单状态相关类型（扩展现有）

**前端文件位置** [Source: architecture/unified-project-structure.md]:
- frontend/admin-panel/src/pages/customer/orders/OrderStatusPage.tsx - 客户订单状态页面（需创建）
- frontend/admin-panel/src/pages/merchant/orders/OrderManagePage.tsx - 商户订单管理页面（需创建）
- frontend/admin-panel/src/components/orders/OrderStatusHistory.tsx - 订单状态历史组件（需创建）
- frontend/admin-panel/src/components/orders/OrderBatchActions.tsx - 批量操作组件（需创建）
- frontend/admin-panel/src/services/orderStatusService.ts - 订单状态API服务（需创建）
- frontend/admin-panel/src/stores/orderStatusStore.ts - 订单状态管理Store（需创建）
- frontend/admin-panel/src/hooks/useOrderStatus.ts - 订单状态Hook（需创建）

### Database Schema
**订单状态管理数据库结构** [基于architecture/database-schema.md]:
```sql
-- 订单状态历史表（新增）
CREATE TABLE order_status_history (
    id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    tenant_id BIGINT UNSIGNED NOT NULL,
    order_id BIGINT UNSIGNED NOT NULL,
    from_status TINYINT NOT NULL,
    to_status TINYINT NOT NULL,
    reason VARCHAR(255) NOT NULL,
    operator_id BIGINT UNSIGNED,
    operator_type ENUM('customer', 'merchant', 'system', 'admin') NOT NULL DEFAULT 'system',
    metadata JSON,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_tenant_id (tenant_id),
    INDEX idx_order_id (order_id),
    INDEX idx_to_status (to_status),
    INDEX idx_created_at (created_at),
    INDEX idx_operator (operator_id, operator_type),
    CONSTRAINT fk_status_history_order FOREIGN KEY (order_id) REFERENCES orders (id) ON DELETE CASCADE
);

-- 订单超时配置表（新增）
CREATE TABLE order_timeout_configs (
    id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    tenant_id BIGINT UNSIGNED NOT NULL,
    merchant_id BIGINT UNSIGNED,
    payment_timeout_minutes INT NOT NULL DEFAULT 30,
    processing_timeout_hours INT NOT NULL DEFAULT 24,
    auto_complete_enabled BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX idx_tenant_id (tenant_id),
    INDEX idx_merchant_id (merchant_id),
    UNIQUE KEY uk_tenant_merchant (tenant_id, merchant_id)
);

-- 订单通知记录表（新增）
CREATE TABLE order_notifications (
    id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    tenant_id BIGINT UNSIGNED NOT NULL,
    order_id BIGINT UNSIGNED NOT NULL,
    notification_type ENUM('sms', 'email', 'push', 'websocket') NOT NULL,
    recipient_type ENUM('customer', 'merchant') NOT NULL,
    recipient_id BIGINT UNSIGNED NOT NULL,
    content TEXT NOT NULL,
    status ENUM('pending', 'sent', 'failed') NOT NULL DEFAULT 'pending',
    sent_at TIMESTAMP NULL,
    error_message TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_tenant_id (tenant_id),
    INDEX idx_order_id (order_id),
    INDEX idx_status (status),
    INDEX idx_recipient (recipient_type, recipient_id),
    CONSTRAINT fk_notification_order FOREIGN KEY (order_id) REFERENCES orders (id) ON DELETE CASCADE
);

-- 扩展orders表（添加字段）
ALTER TABLE orders 
ADD COLUMN status_updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
ADD INDEX idx_status_updated_at (status_updated_at);
```

### Technical Constraints
**订单状态管理架构约束** [Source: architecture/coding-standards.md]:
- 所有订单状态变更必须记录到状态历史表，确保审计追踪
- 订单状态流转必须遵循业务规则，禁止非法状态跳转
- 批量操作必须支持事务回滚，确保数据一致性
- 超时处理必须实现幂等性，防止重复处理

**性能要求** [基于现有系统模式]:
- 订单列表查询响应时间<300ms，支持高并发访问
- 订单状态变更操作响应时间<200ms，包含通知发送
- 批量操作支持最多100个订单同时处理
- 实时状态更新延迟<1秒，支持WebSocket长连接

**外部API集成** [Source: architecture/external-apis.md]:
- **WebSocket服务**: 实现订单状态实时推送
- **定时任务服务**: 集成Go定时器或外部Cron Job系统
- 复用现有的阿里云短信和邮件通知服务

### Testing Requirements
**测试框架和方法** [Source: architecture/testing-strategy.md]:
- **后端测试**: GoConvey 1.8+ BDD风格测试，覆盖率要求≥85%
- **前端测试**: Jest + RTL 29.0+ 单元和集成测试
- **WebSocket测试**: 使用WebSocket测试客户端验证实时更新
- **定时任务测试**: 使用时间Mock验证超时处理逻辑

**测试文件位置** [Source: architecture/testing-strategy.md]:
- backend/services/order-service/test/unit/order_status_test.go
- backend/services/order-service/test/unit/order_timeout_test.go
- backend/services/order-service/test/integration/order_status_api_test.go
- frontend/admin-panel/src/__tests__/orders/OrderStatusPage.test.tsx
- frontend/admin-panel/src/__tests__/orders/OrderManagePage.test.tsx

**具体测试用例**:
- 订单状态流转的业务规则验证测试
- 订单状态历史记录的完整性测试
- 批量操作的事务性和原子性测试
- 超时处理的定时任务和幂等性测试
- WebSocket实时更新的端到端测试
- 多租户隔离的订单状态数据安全测试

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-08-24 | 1.0 | Initial story creation based on Epic 4 requirements | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
[将由开发代理在实施期间填写]

### Debug Log References
[将由开发代理在实施期间填写]

### Completion Notes List
[将由开发代理在完成故事实施后填写]

## QA Results

[将由QA代理在完成故事实施的QA审查后填写]