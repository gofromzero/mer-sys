# Story 1.4: tenant-registration-management

## Status
Approved

## Story
**As a** 平台运营者,
**I want** 支持新租户的注册和基础信息管理,
**so that** 扩展平台的用户基础

## Acceptance Criteria

1. 租户注册API实现，包含基础信息验证
2. 租户信息CRUD操作API
3. 租户状态管理（活跃、暂停、停用）
4. 租户配置信息存储和管理
5. 租户管理界面实现，支持租户列表查看和基础操作
6. 租户注册流程的前端界面完成
7. 租户信息修改和状态变更的权限控制

## Tasks / Subtasks

- [x] Task 1: 扩展租户数据模型和API设计 (AC: 1, 2)
  - [x] 扩展现有tenant表结构，添加业务相关字段
  - [x] 设计租户注册和CRUD API端点路由结构
  - [x] 实现租户数据验证规则和约束
  - [x] 创建租户API的请求/响应模型

- [x] Task 2: 实现租户状态管理系统 (AC: 3)
  - [x] 定义租户状态枚举和转换规则
  - [x] 实现状态变更API端点和业务逻辑
  - [x] 添加状态变更的审计日志记录
  - [x] 集成现有的权限验证中间件

- [x] Task 3: 开发租户配置管理功能 (AC: 4)
  - [x] 设计租户配置数据结构和存储方案
  - [x] 实现配置的读取、更新和版本管理
  - [x] 集成Redis缓存用于配置快速访问
  - [x] 创建配置变更的通知机制

- [ ] Task 4: 构建租户管理前端界面 (AC: 5, 6)
  - [ ] 使用Amis框架创建租户列表页面
  - [ ] 实现租户注册表单和验证
  - [ ] 集成租户状态管理UI操作
  - [ ] 添加搜索、筛选和分页功能

- [ ] Task 5: 实现权限控制和安全机制 (AC: 7)
  - [ ] 实现租户操作的权限验证
  - [ ] 添加敏感操作的二次确认
  - [ ] 完善审计日志和操作记录

- [ ] Task 6: 单元测试和集成测试
  - [ ] 编写租户API的单元测试
  - [ ] 创建前端组件的测试用例
  - [ ] 实现端到端的租户注册流程测试
  - [ ] 验证权限控制和安全机制的测试

## Dev Notes

### Previous Story Insights
从Story 1.3的完成记录中获得的关键信息：
- BaseRepository已实现租户隔离机制，支持自动注入tenant_id过滤条件 [Source: Story 1.3 completion notes]
- 审计日志系统已完善，可记录所有跨租户访问尝试和安全违规事件 [Source: Story 1.3 completion notes]
- TenantPoolManager已实现，支持租户级别的数据库连接池配置和管理 [Source: Story 1.3 completion notes]
- 认证中间件已增强，自动提取客户端IP和User-Agent信息用于审计追踪 [Source: Story 1.3 completion notes]

### Data Models
**Tenant Entity** [Source: architecture/data-models.md#Tenant]:
```typescript
interface Tenant {
  id: string;
  name: string;
  code: string;
  status: TenantStatus;
  config: TenantConfig;
  created_at: Date;
  updated_at: Date;
}

enum TenantStatus {
  ACTIVE = 'active',
  SUSPENDED = 'suspended', 
  EXPIRED = 'expired'
}
```

**需要扩展的租户字段** [基于AC 1需求]:
- business_type: VARCHAR(50) - 业务类型
- contact_person: VARCHAR(100) - 联系人
- contact_email: VARCHAR(100) - 联系邮箱
- contact_phone: VARCHAR(20) - 联系电话
- address: TEXT - 地址信息
- registration_time: DATETIME - 注册时间
- activation_time: DATETIME - 激活时间

### API Specifications
**RESTful API设计规范** [Source: architecture/tech-stack.md]:
- 使用OpenAPI 3.0标准进行API文档化
- 遵循RESTful设计原则
- API路径使用kebab-case命名 [Source: architecture/coding-standards.md]

**租户管理API端点设计**:
- POST /api/v1/tenants - 租户注册
- GET /api/v1/tenants - 租户列表查询
- GET /api/v1/tenants/{id} - 获取特定租户信息
- PUT /api/v1/tenants/{id} - 更新租户信息
- PUT /api/v1/tenants/{id}/status - 变更租户状态
- GET /api/v1/tenants/{id}/config - 获取租户配置
- PUT /api/v1/tenants/{id}/config - 更新租户配置

### Component Specifications
**前端组件架构** [Source: architecture/frontend-architecture.md]:
- 使用React 18.2+ + TypeScript 5.3+ [Source: architecture/tech-stack.md]
- 采用Amis 6.0+低代码框架构建管理界面 [Source: architecture/tech-stack.md]
- 状态管理使用Zustand 4.4+ [Source: architecture/tech-stack.md]

**租户管理页面组件位置** [Source: architecture/unified-project-structure.md]:
- frontend/admin-panel/src/pages/tenant/ - 租户管理页面
- frontend/admin-panel/src/components/tenant/ - 租户相关组件
- frontend/admin-panel/src/services/tenantService.ts - 租户API服务封装

**Amis Schema示例**:
```typescript
const tenantListSchema = {
  type: 'page',
  title: '租户管理',
  body: {
    type: 'crud',
    api: '/api/v1/tenants',
    columns: [
      {name: 'name', label: '租户名称', searchable: true},
      {name: 'code', label: '租户代码'},
      {name: 'status', label: '状态', type: 'status'},
      {name: 'created_at', label: '创建时间', type: 'datetime'}
    ]
  }
}
```

### File Locations
**后端文件位置** [Source: architecture/unified-project-structure.md]:
- backend/services/tenant-service/ - 租户服务主目录
- backend/shared/repository/tenant.go - 租户数据访问层（需扩展现有）
- backend/shared/types/tenant.go - 租户类型定义（需扩展现有）
- backend/shared/database/migrations/ - 数据库迁移文件

**前端文件位置** [Source: architecture/unified-project-structure.md]:
- frontend/admin-panel/src/pages/tenant/ - 租户管理页面
- frontend/admin-panel/src/services/tenantService.ts - 租户API服务
- frontend/admin-panel/src/stores/tenantStore.ts - 租户状态管理
- frontend/shared/types/tenant.ts - 共享TypeScript类型

### Technical Constraints
**认证和授权约束** [Source: architecture/backend-architecture.md]:
- 所有API必须通过AuthMiddleware进行JWT验证
- 权限检查必须使用现有的RBAC权限模型
- 敏感操作需要二次权限验证

**数据访问约束** [Source: architecture/coding-standards.md]:
- 必须通过Repository模式访问数据库，禁止直接SQL操作
- 所有数据查询必须自动添加tenant_id过滤，防止数据泄露
- 使用现有的BaseRepository进行租户隔离

**前端开发约束** [Source: architecture/coding-standards.md]:
- 前端禁止直接HTTP调用，必须通过service层封装
- 所有数据类型必须定义在shared包中，前后端从统一位置导入
- 禁止直接变更state，必须使用proper的状态管理模式

### Testing

**测试框架和标准** [Source: architecture/testing-strategy.md]:
- 后端使用GoConvey 1.8+进行BDD风格测试
- 前端使用Jest + RTL 29.0+进行单元和集成测试
- E2E测试使用Playwright 1.40+

**测试文件位置** [Source: architecture/testing-strategy.md]:
- 后端测试: backend/services/tenant-service/test/
- 前端测试: frontend/admin-panel/src/__tests__/
- E2E测试: test/e2e/ (项目根目录)

**特定测试要求**:
- 租户注册流程的完整E2E测试
- 租户状态管理的权限验证测试
- 租户配置的缓存一致性测试
- 跨租户访问防护的安全测试

**测试命令**:
- 后端测试: `go test ./...` (从backend目录)
- 前端测试: `npm run test` (从frontend/admin-panel目录)
- E2E测试: `npm run test:e2e` (从项目根目录)

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-18 | 1.0 | Initial story creation based on Epic 1 requirements | Bob (Scrum Master) |

## Dev Agent Record

*This section will be populated by the development agent during implementation*

### Agent Model Used
*To be filled by dev agent*

### Debug Log References
*To be filled by dev agent*

### Completion Notes List
*To be filled by dev agent*

### File List
*To be filled by dev agent*

## QA Results

*This section will be populated by the QA agent during review*