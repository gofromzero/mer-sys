# Story 1.2: 用户认证与授权系统

## Status

Draft

## Story

**As a** 系统管理员，
**I want** 一个安全的认证授权系统，
**so that** 能够控制不同角色用户的访问权限。

## Acceptance Criteria

1. JWT token生成和验证机制实现
2. 用户登录/登出API接口完成
3. RBAC权限模型设计，支持租户管理员、商户、客户三种角色
4. 权限中间件实现，确保API访问控制
5. 密码加密存储和验证机制
6. Token刷新机制实现
7. 登录页面UI实现并集成认证API

## Tasks / Subtasks

- [ ] **Task 1: JWT认证机制实现** (AC: 1, 6)
  - [ ] 在shared/auth/jwt.go中扩展JWT管理器，添加角色和权限声明
  - [ ] 实现Token生成时包含用户角色和权限信息
  - [ ] 添加Token刷新逻辑，确保安全性和续期机制
  - [ ] 创建Token撤销黑名单机制，防止已撤销Token被重用
  - [ ] 编写JWT认证单元测试，覆盖生成、验证、刷新场景

- [ ] **Task 2: 用户登录/登出API接口** (AC: 2, 5)
  - [ ] 在backend/services/user-service/中创建认证控制器
  - [ ] 实现登录接口 POST /api/v1/auth/login，包含密码验证和Token生成
  - [ ] 实现登出接口 POST /api/v1/auth/logout，处理Token撤销
  - [ ] 添加密码加密存储机制，使用bcrypt加密算法
  - [ ] 创建密码验证逻辑，确保密码强度和安全性
  - [ ] 编写认证API的集成测试，覆盖正常和异常流程

- [ ] **Task 3: RBAC权限模型设计** (AC: 3)
  - [ ] 在shared/types/中定义Role和Permission类型
  - [ ] 设计租户管理员(tenant_admin)、商户(merchant)、客户(customer)三种角色
  - [ ] 创建权限枚举，包含用户管理、商户管理、订单管理等权限
  - [ ] 在数据库中创建用户角色关联表user_roles
  - [ ] 实现角色权限验证逻辑，支持动态权限检查
  - [ ] 编写RBAC模型的单元测试，验证权限继承和检查逻辑

- [ ] **Task 4: 权限中间件实现** (AC: 4)
  - [ ] 在shared/middleware/中创建认证中间件auth.go
  - [ ] 实现JWT Token提取和验证逻辑
  - [ ] 添加权限检查中间件，支持基于角色和权限的访问控制
  - [ ] 配置公开路径白名单，排除健康检查和登录等端点
  - [ ] 集成租户上下文，确保多租户隔离
  - [ ] 编写中间件测试，验证认证和权限控制逻辑

- [ ] **Task 5: 登录页面UI实现** (AC: 7)
  - [ ] 更新frontend/admin-panel/src/pages/auth/LoginPage.tsx实现完整登录功能
  - [ ] 集成认证API，替换模拟登录逻辑
  - [ ] 添加表单验证，包含用户名、密码必填验证
  - [ ] 实现登录状态管理，更新Zustand store
  - [ ] 添加登录错误处理和用户提示
  - [ ] 实现"记住我"功能，使用localStorage持久化Token
  - [ ] 编写登录页面的组件测试，验证交互和状态更新

- [ ] **Task 6: 认证系统集成测试** (AC: 1-7)
  - [ ] 创建端到端认证流程测试
  - [ ] 验证登录后Token在后续API调用中的自动携带
  - [ ] 测试Token过期和刷新机制
  - [ ] 验证不同角色用户的权限隔离
  - [ ] 测试登出后Token失效和清理
  - [ ] 执行安全测试，验证认证绕过和权限提升防护

## Dev Notes

### Previous Story Insights
基于Story 1.1的完成情况，以下关键基础设施已就绪：
- JWT令牌管理基础框架已在shared/auth/jwt.go中实现
- 用户和租户类型定义已在shared/types/中完成
- 数据库连接和Repository模式已配置完成
- 前端认证页面和状态管理基础结构已创建
- Redis缓存系统已配置，可用于Token存储和会话管理

### Data Models
基于架构文档data-models.md中的定义：

**User Entity** [Source: architecture/data-models.md#user-用户]
```typescript
interface User {
  id: string;
  uuid: string;
  username: string;
  email: string;
  phone?: string;
  status: UserStatus;
  tenant_id: string;
  roles: UserRole[];
  profile?: UserProfile;
  created_at: Date;
  updated_at: Date;
  last_login_at?: Date;
}

enum UserStatus {
  PENDING = 'pending',
  ACTIVE = 'active', 
  SUSPENDED = 'suspended',
  DEACTIVATED = 'deactivated'
}

interface UserRole {
  id: string;
  user_id: string;
  role_type: RoleType;
  resource_id?: string;
  permissions: string[];
}
```

### API Specifications
基于架构文档api-specification.md中的认证API定义：

**Login Endpoint** [Source: architecture/api-specification.md#rest-api-specification]
- Endpoint: `POST /api/v1/auth/login`
- Request: `{ username, password, tenant_id }`
- Response: `{ access_token, user }`
- Authentication: 不需要（公开端点）

**Users API** [Source: architecture/api-specification.md#rest-api-specification]
- Endpoint: `GET /api/v1/users`
- Authentication: Bearer Token required
- Authorization: 需要用户管理权限

### Component Specifications
基于前端架构文档frontend-architecture.md中的定义：

**认证页面结构** [Source: architecture/frontend-architecture.md#component-organization]
```
src/pages/auth/
├── LoginPage.tsx     # 登录页面（已存在，需增强）
├── LogoutPage.tsx    # 登出页面
└── index.ts          # 导出文件
```

**状态管理结构** [Source: architecture/frontend-architecture.md#state-structure]
```typescript
interface AuthState {
  user: User | null;
  token: string | null;
  permissions: string[];
  isLoading: boolean;
}
```

**API Client配置** [Source: architecture/frontend-architecture.md#api-client-setup]
- baseURL: 'http://localhost:8080/api/v1'
- 自动Token注入和401响应处理
- 使用axios拦截器管理认证状态

### File Locations
基于统一项目结构文档unified-project-structure.md中的定义：

**后端认证相关文件** [Source: architecture/unified-project-structure.md]
```
backend/
├── shared/
│   ├── types/auth.go         # 认证相关类型定义
│   ├── middleware/auth.go    # 认证中间件
│   └── auth/jwt.go          # JWT管理器（已存在，需扩展）
├── services/user-service/
│   ├── internal/controller/auth.go  # 认证控制器
│   ├── internal/service/auth.go     # 认证业务逻辑
│   └── internal/repository/user.go  # 用户数据访问（已存在）
```

**前端认证相关文件** [Source: architecture/unified-project-structure.md]
```
frontend/admin-panel/src/
├── pages/auth/
│   ├── LoginPage.tsx        # 登录页面（已存在，需增强）
│   └── LogoutPage.tsx       # 登出页面
├── services/
│   └── authService.ts       # 认证API服务
├── stores/
│   └── authStore.ts         # 认证状态管理（已存在，需增强）
└── hooks/
    └── useAuth.ts           # 认证Hook
```

### Authentication Flow
基于核心工作流程文档core-workflows.md中的登录流程：

**登录流程** [Source: architecture/core-workflows.md#用户登录流程]
1. 客户端 -> API Gateway: POST /auth/login
2. API Gateway -> User Service: 转发登录请求
3. User Service: 验证用户凭证和状态
4. User Service -> Redis: 存储会话信息
5. User Service: 生成JWT token
6. 返回token和用户信息

### Security Requirements
基于后端架构文档backend-architecture.md中的认证要求：

**JWT Token结构** [Source: architecture/backend-architecture.md#authentication-and-authorization]
- 包含用户ID、租户ID、权限列表
- 支持Token黑名单机制
- Redis存储会话状态

**公开路径配置** [Source: architecture/backend-architecture.md#middlewareguards]
```go
publicPaths := []string{
    "/api/v1/auth/login",
    "/api/v1/auth/register", 
    "/api/v1/health",
}
```

### Technical Constraints
基于技术栈文档tech-stack.md中的版本要求：

**认证相关技术栈** [Source: architecture/tech-stack.md#technology-stack-table]
- JWT: RFC 7519标准
- GoFrame: 2.6+ 用于后端框架
- React: 18.2+ 用于前端登录界面
- Redis: 7.0+ 用于会话存储
- bcrypt: 密码加密算法

### Critical Fullstack Rules
基于编码标准文档coding-standards.md中的关键规则：

**必须遵循的规则** [Source: architecture/coding-standards.md#critical-fullstack-rules]
- 类型定义必须在shared包中统一管理
- 前端禁止直接HTTP调用，必须通过service层封装
- 数据库访问必须通过Repository模式
- 所有数据查询必须自动添加tenant_id过滤
- 敏感操作必须进行权限验证

### Testing Requirements
基于测试策略文档testing-strategy.md中的要求：

**测试文件位置** [Source: architecture/testing-strategy.md#test-organization]
- 前端测试: `frontend/admin-panel/src/__tests__/`
- 后端测试: `backend/services/user-service/test/unit/`, `*_test.go`

**测试框架** [Source: architecture/tech-stack.md#technology-stack-table]
- 前端: Jest + React Testing Library 29.0+
- 后端: GoConvey 1.8+
- E2E: Playwright 1.40+

**必需测试用例：**
1. JWT Token生成和验证测试
2. 登录API端点测试（成功和失败场景）
3. 权限中间件测试
4. 前端登录页面交互测试
5. 认证流程端到端测试
6. RBAC权限验证测试

### Project Structure Notes
项目结构与架构文档完全一致。需要特别注意：
1. 认证中间件必须正确集成租户上下文隔离
2. JWT管理器需要扩展以支持角色和权限
3. 前端认证状态管理需要与现有Zustand store集成
4. 所有认证相关API必须遵循统一的错误处理格式

## Testing

**Test File Locations** [Source: architecture/testing-strategy.md#test-organization]
- Frontend Tests: `frontend/admin-panel/src/__tests__/`
- Backend Tests: `backend/services/user-service/test/unit/`, `*_test.go`

**Testing Frameworks** [Source: architecture/tech-stack.md#technology-stack-table]
- Frontend: Jest + React Testing Library 29.0+
- Backend: GoConvey 1.8+
- E2E: Playwright 1.40+

**Required Test Cases:**
1. JWT Token管理测试 - 验证Token生成、验证、刷新、撤销功能
2. 用户认证API测试 - 验证登录、登出接口的正确性
3. RBAC权限模型测试 - 验证角色权限分配和检查逻辑
4. 认证中间件测试 - 验证Token验证和权限控制
5. 登录页面组件测试 - 验证用户交互和状态更新
6. 认证流程集成测试 - 验证完整的登录到API调用流程

**Testing Standards:**
- 遵循测试金字塔原则：单元测试35%, 集成测试20%, E2E测试10%
- 所有新建的认证API端点必须包含单元测试
- 前端登录组件必须包含渲染测试和交互测试
- 权限验证逻辑必须包含完整的安全测试覆盖

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-08-16 | 1.0 | 初始故事创建，基于Epic 1.2需求 | Bob (SM) |

## Dev Agent Record

*This section will be populated by the development agent during implementation*

### Agent Model Used

*To be filled by dev agent*

### Debug Log References

*To be filled by dev agent*

### Completion Notes List

*To be filled by dev agent*

### File List

*To be filled by dev agent*

## QA Results

*Results from QA Agent review will be populated here after story completion*